<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>SuperMarkdownEditor</title>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $.ajax({
            type: "get",
            url: "/api/v1/ping",
            async: false,
            success: function (data) {
                if (data.code !== 200) {
                    $(location).attr("href", "login")
                }
            },
            error: function () {
                $(location).attr("href", "login")
            }
        });
    </script>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/fontawesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor/dist/index.css"/>
    <script src="https://cdn.jsdelivr.net/npm/vditor/dist/method.min.js"></script>

</head>

<body>
<div class="container-fluid h-100 w-90">
    <h1 id="articleTitle" style="text-align: center">Markdown转HTML的显示处理之自定义 ToC 容器</h1>
    <div id="outline"></div>
    <div id="preview" class="vditor" style="padding-right: 250px;"></div>
</div>
<script type="text/javascript">
    function getQueryVariable(variable) {
        let query = window.location.search.substring(1);
        let vars = query.split("&");
        for (let i = 0; i < vars.length; i++) {
            let pair = vars[i].split("=");
            if (pair[0] === variable) {
                return pair[1];
            }
        }
        return "";
    }

    let article_id = getQueryVariable("id");

    const initOutline = () => {
        const headingElements = []
        Array.from(document.getElementById('preview').children).forEach((item) => {
            if (item.tagName.length === 2 && item.tagName !== 'HR' && item.tagName.indexOf('H') === 0) {
                headingElements.push(item)
            }
        })

        let toc = []
        window.addEventListener('scroll', () => {
            const scrollTop = window.scrollY
            toc = []
            headingElements.forEach((item) => {
                toc.push({
                    id: item.id,
                    offsetTop: item.offsetTop,
                })
            })

            const currentElement = document.querySelector('.vditor-outline__item--current')
            for (let i = 0, iMax = toc.length; i < iMax; i++) {
                if (scrollTop < toc[i].offsetTop - 30) {
                    if (currentElement) {
                        currentElement.classList.remove('vditor-outline__item--current')
                    }
                    let index = i > 0 ? i - 1 : 0
                    document.querySelector('span[data-target-id="' + toc[index].id + '"]').classList.add('vditor-outline__item--current')
                    break
                }
            }
        })
    }

    $(function () {
        $.get("/api/v1/content?id=" + article_id, function (data, status) {
            if (data && status === 'success') {
                $("#articleTitle").text(data.data.title);
                $(document).attr("title", data.data.title);
                Vditor.preview(document.getElementById('preview'),
                    data.data.data, {
                        anchor: 1,
                        after () {
                            if (window.innerWidth <= 768) {
                                return
                            }
                            const outlineElement = document.getElementById('outline')
                            Vditor.outlineRender(document.getElementById('preview'), outlineElement)
                            if (outlineElement.innerText.trim() !== '') {
                                outlineElement.style.display = 'block';
                                // outlineElement.style.float = 'right';
                                outlineElement.style.position='fixed';
                                outlineElement.style.top='10em';
                                outlineElement.style.right='0px';
                                initOutline()
                            }
                        },
                    })
            }
        });
    });
</script>
</body>


<body>
</body>
</html>
