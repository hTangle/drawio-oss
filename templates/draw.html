<html>
<body>
<script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
<script>
    $.ajax({
        type: "get",
        url: "/api/v1/ping",
        async: false,
        success: function (data) {
            if (data.code !== 200) {
                $(location).attr("href", "login")
            }
        },
        error: function () {
            $(location).attr("href", "login")
        }
    });
</script>
<link href="https://cdn.staticfile.org/bootstrap/5.0.2/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdn.staticfile.org/bootstrap/5.0.2/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="/api/js/diagram-editor.js"></script>

<div class="container">
    <div class="input-group" style="margin-top:30px">
        <input id="searchForImage" type="text" class="form-control"
               aria-label="Text input with segmented dropdown button">
        <button class="btn btn-outline-secondary" type="button" onclick="SearchForImage()" style="z-index: 0">搜索</button>
    </div>
    <div class="d-grid gap-2" style="margin-bottom: 20px;margin-top:10px">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
            新建流程图
        </button>
    </div>

    <div class="row row-cols-1 row-cols-md-4 g-4" id="gallery">

    </div>

    <textarea id="copy" style="display: none"></textarea>
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                复制成功
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">新建流程图</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="exampleInputEmail1" class="form-label">文件名</label>
                        <input type="text" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp">
                        <div id="emailHelp" class="form-text">支持数字字母组合</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="addNewImage()">Enter</button>
            </div>
        </div>
    </div>
</div>
<script>
    var myModal = new bootstrap.Modal(document.getElementById('exampleModal'), {
        keyboard: false
    })
    let searchKey = "";

    function SearchForImage() {
        console.log($("#searchForImage").val(),searchKey);
        if ($("#searchForImage").val() !== searchKey) {
            searchKey = $("#searchForImage").val();
            $.ajax({
                type: "get",
                url: "/api/v1/images?key="+searchKey,
                async: true,
                success: function (data) {
                    console.log(data)
                    if (data.status === 200) {
                        $("#gallery").empty();
                        console.log(data.data)
                        const obj = data.data;
                        Object.getOwnPropertyNames(obj).forEach(function (key) {
                            console.log(key, obj[key]);
                            addDrawIoData(key, obj[key])
                        })
                    }
                }
            });
        }
    }

    function addNewImage() {
        var key = $("#exampleInputEmail1").val();
        console.log(key)
        myModal.toggle()
        if (key !== "") {
            $.ajax({
                type: "put",
                url: "/api/v1/image?key=" + key,
                async: true,
                success: function (data) {
                    if (data && data.status === 200 && data.success === true) {
                        addDrawIoData(key, data.data);
                    } else {
                        alert(JSON.stringify(data));
                    }
                }
            });
        }

    }

    function addDrawIoData(key, value) {
        var tmpHtml = "<div class=\"col\"><div class=\"card\" style=\"width: 18rem;\">" +
            "<img src=\"" + value + "\"" + "class=\"card-img-top\" alt=\"" + key + "\" " +
            "onclick='DiagramEditor.editElement(this);'  style=\"height: 200px\"" +
            "> <div class=\"card-body\">" +
            "<p class=\"card-text\">" + key + "</p>" +
            "<div class=\"btn-group\" role=\"group\" aria-label=\"Basic example\">" +
            "<a href=\"#\" class=\"btn btn-outline-primary\" onclick='copyUrl(\"" + value + "\")'>复制Url</a>" +
            "<a href=\"#\" class=\"btn btn-outline-primary\" onclick='copyUrl(\"![" + key + "](" + value + ")\")'>复制Markdown</a>" +
            "</div></div></div></div>";
        $("#gallery").prepend(tmpHtml);
    }

    var toastLiveExample = document.getElementById('liveToast')

    function copyUrl(url) {
        $("#copy").text(url).show();
        var ele = document.getElementById("copy");
        ele.select();
        document.execCommand("copy", false, null);
        $("#copy").text(url).hide();
        console.log("复制成功");
        var toast = new bootstrap.Toast(toastLiveExample)
        toast.show()
    }

    $(function () {
        $.ajax({
            type: "get",
            url: "/api/v1/images",
            async: true,
            success: function (data) {
                console.log(data)
                if (data.status === 200) {
                    console.log(data.data)
                    const obj = data.data;
                    Object.getOwnPropertyNames(obj).forEach(function (key) {
                        console.log(key, obj[key]);
                        addDrawIoData(key, obj[key])
                    })
                }
            }
        });
    })
</script>
<!--<img alt="test" onclick='DiagramEditor.editElement(this);'-->
<!--     src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHkAAAA9CAYAAACJM8YzAAADT3RFWHRteGZpbGUAJTNDbXhmaWxlJTIwaG9zdCUzRCUyMmVtYmVkLmRpYWdyYW1zLm5ldCUyMiUyMG1vZGlmaWVkJTNEJTIyMjAyMS0wMS0xMVQxMCUzQTQxJTNBMzQuMjQ4WiUyMiUyMGFnZW50JTNEJTIyNS4wJTIwKE1hY2ludG9zaCUzQiUyMEludGVsJTIwTWFjJTIwT1MlMjBYJTIwMTFfMV8wKSUyMEFwcGxlV2ViS2l0JTJGNTM3LjM2JTIwKEtIVE1MJTJDJTIwbGlrZSUyMEdlY2tvKSUyMENocm9tZSUyRjg3LjAuNDI4MC44OCUyMFNhZmFyaSUyRjUzNy4zNiUyMiUyMGV0YWclM0QlMjJtNXI1QVhFdDE3eWx2WWlEWXo5UyUyMiUyMHZlcnNpb24lM0QlMjIxNC4xLjklMjIlMjB0eXBlJTNEJTIyZW1iZWQlMjIlM0UlM0NkaWFncmFtJTIwaWQlM0QlMjJlbVlSU0REUmtEUDJZZDNFWnkzciUyMiUyMG5hbWUlM0QlMjJQYWdlLTElMjIlM0VqWkxOVG9Rd0VJQ2ZwbGV6MEloNkZkZjE0Z2tUejVXT3ROblNrbElXOE9sdDdWUm9OaVplWU9hYjZmd1RXdmZMeWJKQnZCb09pcFFIdmhENlJNcXlxS283JTJGd3RramVTV1BrVFFXY2tqT215Z2tWJTJCQUx4T2RKSWNSV1VUT0dPWGtrTVBXYUEydHl4aXoxc3k1MjZkUmVkYUJkWkI1Qk5DMFRGM1RkOG1kaVBTJTJCckRiJTJCQXJJVEtYTlJZWDhmckQxMzFrd2E4Mm1qSVZwNmxzSmdEYU5nM013N1JJJTJCRTF0WVlGNlYlMkJxVUdGc2VZVGUlMkY3RGlpV1BiazFOcEZvdGFQZXZDS21KQzFNVHhuZ1RjZ3d1NGNQQ0ZtQjBOMWVaWmlFZE5BTnJnejc3a3lEMFViaGVlYTN3NG5VaFdPd0ZySU5saDdDd0U1Z2VuRjI5QzFyVDBOWmNuYmZsRkltSjNXSXFaQXp2b2ZzTnZNM0JDemlLcEc0NyUyQkxIdGJwd2V2d0UlM0QlM0MlMkZkaWFncmFtJTNFJTNDJTJGbXhmaWxlJTNFoE8CRAAABV1JREFUeF7tm1lIlVsYht+NXoSipGkIGpoDBYqiKIIQSCiRSigOCV2odZuSw51KoYaR8xCkGDmiaCDiVM5JSQiKoSiFaVk5UoKK4nz4Fmd73KmdvZX28ez1rZst7rXW/7/vs961vl/8FQB2wU2nHVAQ5J2dHZ0WKbM4PT29XQF5d5fDrIsLgbgyZF0ku08TQ9ZxwCSPITNkCRyQQCInmSFL4IAEEjnJDFkCBySQyElmyBI4IIFETjJDlsABCSRykhmyBA5IIJGTzJAlcEACiZxkhiyBAxJI5CQzZAkckEAiJ5khS+CABBJPTZLpRra3t6Gvry+B7dqVqDXI379/h5WV1ZHq2tvbERUVha9fvx7o8+DBA3z+/BmlpaVquaNpf7UmBfDlyxf09/cjNDRU3SEq/U46/lgX1eZ/a1JK5+bmxH2+f/8efn5+4tPMzEz8bnR09EjIk5OTWF9fx+XLl9XSqWl/tSYF0NjYiHv37uHTp0/qDlHpd9Lxx7qoNiHvv8GBgQG4u7tjfn4e5ubm4quOjg7cunULd+7cQUVFBc6fP4+ioiLR79mzZ5idnUViYiLq6+uRn58PmiMwMBCFhYUwNjZW0a9pfxqcnp6OyspKbG1twd/fHxkZGfTWwd68tHB8fHwwMTGB4OBgvHjxQqQ6ISEBHz58wLVr15CTk4Nz585hcXERtJvU1NSIRfzo0SM4OTkdGH9caJqO09p2rQ5kX19fBAUF4fbt28Iwejeru7sb9+/fB5mcnZ0tFkVtbS1MTEwQHx+PiIgIxMXFqejWtP/w8LAAUFxcLOal7fjp06fiXpRtdXUVeXl5yM3NRWtrKywtLWFhYYHo6GiEhITg8ePHWFpaQm9vLzIzM8WiffjwIV6+fImkpCT8/PlTzKkc7+bmpimrY/c/dZBXVlZgaGgojLx586YwTgktLS0N1tbWKCgoQGRkpDBubW0Nly5dOhSyuv3HxsZE+jw9PfHt2zcBmdJM193f9m+3BCsrKwtTU1NQKBQizXSczMzMIDU1Fe/evUNZWRkcHR3x9u1bENTOzs4TbffHpXyqINN2rTy337x5gytXrohXPJSQy8vLhbG0RVIjEJR4BweHQyGr25+KPToK6JgwMjISc9Eu8TvIlGA6Kn5ttCucPXsW4eHhAq6trS1iY2Nx9+7dE5/pOgF5f3V9GGQCSom7cOEC+vr6BAT6uaqq6lDI6vYnCJQ8OkNppwgLCxMJ/B3k5ORkvHr1Cj09PeLam5ubGBkZgYeHBz5+/IiLFy/ix48faGhoQExMjCgsx8fHOcn/BpkqW29vbwwNDYmEEAQqwJqamg6FrG7/gIAAAYWOgcHBQXENGpuSkqIyb3Nzs6gX6HGwq6tLFFuvX78WYKlQe/LkifiOzmhnZ2fQQlheXhbFGM07PT29N54mpp3gxo0bQsufbKdqu/4dZHrGpOdkSlldXZ2ovmlbfP78Oby8vA5A1qR/W1ubAEONCjt6vCMAtJhcXFz25iZIrq6u4rp0BtOWTsUgNbqf6upqXL16VRSL9Knc+umeS0pKBGTleJrbwMAALS0tuH79+p9k/P98q5EAbmxsHDiLj3JKnf70HE4QbGxsRCG1sLAAU1NTlccomp8esajYUwKkflRH2Nvb48yZM3u3QAUj/QHHzs5OFJLK9uv4P0r378n/kyRrQxhf4x8HGLIEq4EhM2QJHJBAIieZIUvggAQSOckMWQIHJJDISWbIEjgggUROMkOWwAEJJHKSGbIEDkggkZPMkCVwQAKJnGSGLIEDEkjkJDNkCRyQQCInmSFL4IAEEjnJDFkCBySQqJJkCfRKK1GhUOz+BbaftLWDFNYjAAAAAElFTkSuQmCC"-->
<!--     style="cursor:pointer;">-->
</body>
</html>
